<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ledger List</title>

    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">

    <style>
        .table-responsive {
            overflow-x: auto;
            width: 100%;
        }

        #ledgerTable {
            min-width: 1800px;
    
        }

        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }
        .dt-buttons {
            display: flex !important;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }

        #exportButtonsContainer .dt-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dt-button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .dt-button.buttons-excel {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        .dt-button.buttons-excel:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }

        .edit-btn {
            cursor: pointer;
            color: #0d6efd;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .edit-btn:hover {
            background-color: #e9ecef;
        }

        /* Inline editing styles */
        .editable {
            cursor: pointer;
            position: relative;
        }

        .editable:hover {
            background-color: #f8f9fa;
        }

        .editable:after {
            content: "âœŽ";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .editable:hover:after {
            opacity: 1;
        }

        /* Hide pencil icon for Group ID and SubGroup ID columns */
        #ledgerTable td:nth-child(3):after,
        #ledgerTable td:nth-child(5):after {
            display: none !important;
        }

        .editing {
            background-color: #fff3cd !important;
        }

        .editable-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .editable-select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .wizard {
            margin: 20px 0;
        }
        .wizard-progress {
            margin-bottom: 30px;
        }
        .wizard .nav-pills {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .wizard .nav-pills .nav-link {
            padding: 8px 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .wizard .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .wizard .progress {
            height: 4px;
            margin-bottom: 10px;
        }
        .tab-pane {
            padding: 20px 0;
        }
        .form-label {
            font-weight: 500;
        }
        .form-label:after {
            content: " *";
            color: red;
            display: none;
        }
        .form-label[for]:has(+ input[required]):after,
        .form-label[for]:has(+ select[required]):after {
            display: inline;
        }
    </style>


</head>
<body>
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Ledger Records</h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLedgerModal">
            Add New Ledger
        </button>
    </div>
    <div id="exportButtonsContainer" class="d-flex gap-2 mt-3"></div>
    <div class="table-responsive mb-5" style="overflow-x: auto; ">
        <div style="min-width: 1800px;">
            <div class="row mt-3 mb-3 ms-3">
                <div class="col-md-3 d-flex flex-wrap" style="gap: 10px;">
                    <input type="text" id="ledgerNameSearch" class="form-control" placeholder="Search Ledger Name">
                </div>
                <div class="col-md-3">
                    <input type="text" id="groupNameSearch" class="form-control" placeholder="Search Group Name">
                </div>
                <div class="col-md-3">
                    <input type="text" id="subGroupNameSearch" class="form-control" placeholder="Search SubGroup Name">
                </div>
                <div class="col-md-3">
                    <select id="apVersionDropdown" class="form-control">
                        <option value="">All AP Versions</option>
                        <option th:each="ap : ${apVersions}" th:value="${ap}" th:text="${ap}"></option>
                    </select>
                </div>
            </div>

            <table id="ledgerTable" class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Ledger Name</th>
                    <th>Group ID</th>
                    <th>Group Name</th>
                    <th>SubGroup ID</th>
                    <th>SubGroup Name</th>
                    <th>Created Date</th>
                    <th>Is Active</th>
                    <th>Is Deleted</th>
                    <th>Updated Date</th>
                    <th>Version</th>
                    <th>Code</th>
                    <th>Is Group</th>
                    <th>Is Ledger</th>
                    <th>Is SubGroup</th>
                    <th>Created By</th>
                    <th>Updated By</th>
                    <th>Ledger Type ID</th>
                    <th>Parent ID</th>
                    <th>Menu ID</th>
                    <th>Serial Number</th>
                    <th>Formula</th>
                    <th>Is Editable</th>
                    <th>Depreciation Ledger ID</th>
                    <th>Accumulated Depreciation ID</th>
                    <th>Is Optional</th>
                    <th>AP Version</th>
                    <th>FSA Area ID</th>
                    <th>Ledger Header</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="ledger : ${ledgers}">
                    <td>
                        <span th:text="${ledger.id}"></span>
                        <i class="fas fa-pencil-alt edit-btn" th:data-id="${ledger.id}"></i>
                    </td>
                    <td th:text="${ledger.ledgerName}"></td>
                    <td th:text="${ledger.groupId}"></td>
                    <td th:text="${ledger.groupName}"></td>
                    <td th:text="${ledger.subGroupId}"></td>
                    <td th:text="${ledger.subGroupName}"></td>
                    <td th:text="${ledger.createdDate}"></td>
                    <td th:text="${ledger.isActive}"></td>
                    <td th:text="${ledger.isDeleted}"></td>
                    <td th:text="${ledger.updatedDate}"></td>
                    <td th:text="${ledger.version}"></td>
                    <td th:text="${ledger.code}"></td>
                    <td th:text="${ledger.isGroup}"></td>
                    <td th:text="${ledger.isLedger}"></td>
                    <td th:text="${ledger.isSubGroup}"></td>
                    <td th:text="${ledger.createdBy}"></td>
                    <td th:text="${ledger.updatedBy}"></td>
                    <td th:text="${ledger.ledgerTypeId}"></td>
                    <td th:text="${ledger.parentId}"></td>
                    <td th:text="${ledger.tbMenuId}"></td>
                    <td th:text="${ledger.serialNumber}"></td>
                    <td th:text="${ledger.formula}"></td>
                    <td th:text="${ledger.isEditable}"></td>
                    <td th:text="${ledger.depreciationLedgerId}"></td>
                    <td th:text="${ledger.accumulatedDepreciationId}"></td>
                    <td th:text="${ledger.isOptional}"></td>
                    <td th:text="${ledger.apVersion}"></td>
                    <td th:text="${ledger.fsaAreaId}"></td>
                    <td th:text="${ledger.ledgerHeader}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add New Ledger Modal -->
    <div class="modal fade" id="addLedgerModal" tabindex="-1" aria-labelledby="addLedgerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLedgerModalLabel">Add New Ledgerr</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="wizard">
                        <div class="wizard-progress">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <ul class="nav nav-pills">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#step1" data-bs-toggle="pill">Basic Info</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#step2" data-bs-toggle="pill">Type & Status</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#step3" data-bs-toggle="pill">Additional Info</a>
                                </li>
                            </ul>
                        </div>
                        <div class="tab-content">
                            <!-- Step 1: Basic Information -->
                            <div class="tab-pane fade show active" id="step1">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="ledgerName" class="form-label">Ledger Name</label>
                                        <input type="text" class="form-control" id="ledgerName">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="code" class="form-label">Code</label>
                                        <input type="text" class="form-control" id="code" maxlength="16">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="groupSelect" class="form-label">Group</label>
                                        <select class="form-select" id="groupSelect">
                                            <option value="">Select Group</option>
                                            <option th:each="group : ${groups}" th:value="${group.id}" th:text="${group.ledgerName}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="subGroupSelect" class="form-label">Subgroup</label>
                                        <select class="form-select" id="subGroupSelect">
                                            <option value="">Select Subgroup</option>
                                            <option th:each="subgroup : ${subgroups}" th:value="${subgroup.id}" th:text="${subgroup.ledgerName}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="version" class="form-label">Version</label>
                                        <input type="number" class="form-control" id="version">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="apVersion" class="form-label">AP Version</label>
                                        <input type="number" class="form-control" id="apVersion">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ledgerHeader" class="form-label">Ledger Header</label>
                                        <input type="text" class="form-control" id="ledgerHeader" maxlength="100">
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Type & Status -->
                            <div class="tab-pane fade" id="step2">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="isActive" class="form-label">Is Active</label>
                                        <select class="form-select" id="isActive">
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isDeleted" class="form-label">Is Deleted</label>
                                        <select class="form-select" id="isDeleted">
                                            <option value="false" selected>No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Is Group</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="isGroup" id="isGroupYes" value="true">
                                                <label class="form-check-label" for="isGroupYes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="isGroup" id="isGroupNo" value="false" checked>
                                                <label class="form-check-label" for="isGroupNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Is Ledger</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="isLedger" id="isLedgerYes" value="true" checked>
                                                <label class="form-check-label" for="isLedgerYes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="isLedger" id="isLedgerNo" value="false">
                                                <label class="form-check-label" for="isLedgerNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Is SubGroup</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="isSubGroup" id="isSubGroupYes" value="true">
                                                <label class="form-check-label" for="isSubGroupYes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="isSubGroup" id="isSubGroupNo" value="false" checked>
                                                <label class="form-check-label" for="isSubGroupNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isEditable" class="form-label">Is Editable</label>
                                        <select class="form-select" id="isEditable">
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isOptional" class="form-label">Is Optional</label>
                                        <select class="form-select" id="isOptional">
                                            <option value="false" selected>No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Additional Information -->
                            <div class="tab-pane fade" id="step3">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="createdBy" class="form-label">Created By</label>
                                        <input type="number" class="form-control" id="createdBy">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="updatedBy" class="form-label">Updated By</label>
                                        <input type="number" class="form-control" id="updatedBy">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="createdDate" class="form-label">Created Date</label>
                                        <input type="datetime-local" class="form-control" id="createdDate" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="updatedDate" class="form-label">Updated Date</label>
                                        <input type="datetime-local" class="form-control" id="updatedDate" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ledgerTypeId" class="form-label">Ledger Type ID</label>
                                        <input type="number" class="form-control" id="ledgerTypeId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="parentId" class="form-label">Parent ID</label>
                                        <input type="number" class="form-control" id="parentId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="tbMenuId" class="form-label">Menu ID</label>
                                        <input type="number" class="form-control" id="tbMenuId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="serialNumber" class="form-label">Serial Number</label>
                                        <input type="number" class="form-control" id="serialNumber">
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="formula" class="form-label">Formula</label>
                                        <input type="text" class="form-control" id="formula">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="depreciationLedgerId" class="form-label">Depreciation Ledger ID</label>
                                        <input type="number" class="form-control" id="depreciationLedgerId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="accumulatedDepreciationId" class="form-label">Accumulated Depreciation ID</label>
                                        <input type="number" class="form-control" id="accumulatedDepreciationId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="fsaAreaId" class="form-label">FSA Area ID</label>
                                        <input type="number" class="form-control" id="fsaAreaId">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                    <button type="button" class="btn btn-success" id="saveLedgerBtn" style="display: none;">Save Ledger</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- All DataTables, jQuery, and Bootstrap scripts are now loaded only in index.html -->
    <script>
        $(document).ready(function() {
            // Only keep the wizard functionality here
            let currentStep = 1;
            const totalSteps = 3;

            function updateWizardUI() {
                // Update progress bar
                const progress = (currentStep / totalSteps) * 100;
                $('.progress-bar').css('width', progress + '%');

                // Update navigation pills
                $('.nav-pills .nav-link').removeClass('active');
                $(`.nav-pills .nav-link[href="#step${currentStep}"]`).addClass('active');

                // Update tab content
                $('.tab-pane').removeClass('show active');
                $(`#step${currentStep}`).addClass('show active');

                // Update buttons
                $('#prevBtn').toggle(currentStep > 1);
                $('#nextBtn').toggle(currentStep < totalSteps);
                $('#saveLedgerBtn').toggle(currentStep === totalSteps);
            }

            $('#nextBtn').click(function() {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateWizardUI();
                }
            });

            $('#prevBtn').click(function() {
                if (currentStep > 1) {
                    currentStep--;
                    updateWizardUI();
                }
            });

            // Initialize wizard UI
            updateWizardUI();

            // Handle ledger type selection
            $('input[name="ledgerType"]').change(function() {
                const selectedType = $(this).val();
                const groupSelect = $('#groupSelect');
                const subGroupSelect = $('#subGroupSelect');
                
                // Reset all type flags
                $('#isGroupYes').prop('checked', false);
                $('#isGroupNo').prop('checked', true);
                $('#isSubGroupYes').prop('checked', false);
                $('#isSubGroupNo').prop('checked', true);
                $('#isLedgerYes').prop('checked', false);
                $('#isLedgerNo').prop('checked', true);
                
                // Update type flags based on selection
                switch(selectedType) {
                    case 'group':
                        $('#isGroupYes').prop('checked', true);
                        $('#isGroupNo').prop('checked', false);
                        groupSelect.prop('disabled', true);
                        subGroupSelect.prop('disabled', true);
                        break;
                    case 'subgroup':
                        $('#isSubGroupYes').prop('checked', true);
                        $('#isSubGroupNo').prop('checked', false);
                        groupSelect.prop('disabled', false);
                        subGroupSelect.prop('disabled', true);
                        break;
                    case 'ledger':
                        $('#isLedgerYes').prop('checked', true);
                        $('#isLedgerNo').prop('checked', false);
                        groupSelect.prop('disabled', false);
                        subGroupSelect.prop('disabled', false);
                        break;
                }
            });

            // Handle group selection to filter subgroups
            $('#groupSelect').change(function() {
                const selectedGroupId = $(this).val();
                const subGroupSelect = $('#subGroupSelect');
                
                if (selectedGroupId) {
                    // Filter subgroups based on selected group
                    subGroupSelect.find('option').each(function() {
                        const subgroup = $(this);
                        if (subgroup.val() === '') return; // Skip the default option
                        
                        // Show only subgroups that belong to the selected group
                        const parentId = subgroup.data('parent-id');
                        subgroup.toggle(parentId === selectedGroupId);
                    });
                } else {
                    // Show all subgroups if no group is selected
                    subGroupSelect.find('option').show();
                }
            });

            // Update form data before submission
            $('#saveLedgerBtn').click(function() {
                const formData = {
                    ledgerName: $('#ledgerName').val(),
                    code: $('#code').val(),
                    version: $('#version').val(),
                    apVersion: $('#apVersion').val(),
                    ledgerHeader: $('#ledgerHeader').val(),
                    isActive: $('#isActive').val() === 'true',
                    isDeleted: $('#isDeleted').val() === 'true',
                    isGroup: $('#isGroupYes').is(':checked'),
                    isLedger: $('#isLedgerYes').is(':checked'),
                    isSubGroup: $('#isSubGroupYes').is(':checked'),
                    isEditable: $('#isEditable').val() === 'true',
                    isOptional: $('#isOptional').val() === 'true',
                    createdBy: $('#createdBy').val(),
                    updatedBy: $('#updatedBy').val(),
                    ledgerTypeId: $('#ledgerTypeId').val(),
                    tbMenuId: $('#tbMenuId').val(),
                    serialNumber: $('#serialNumber').val(),
                    formula: $('#formula').val(),
                    depreciationLedgerId: $('#depreciationLedgerId').val(),
                    accumulatedDepreciationId: $('#accumulatedDepreciationId').val(),
                    fsaAreaId: $('#fsaAreaId').val()
                };

                // Handle parent ID based on ledger type and selections
                const selectedType = $('input[name="ledgerType"]:checked').val();
                const selectedGroupId = $('#groupSelect').val();
                const selectedSubGroupId = $('#subGroupSelect').val();

                if (selectedType === 'group') {
                    formData.parentId = null; // Groups don't have parents
                } else if (selectedType === 'subgroup') {
                    formData.parentId = selectedGroupId; // Subgroups have groups as parents
                } else if (selectedType === 'ledger') {
                    formData.parentId = selectedSubGroupId || selectedGroupId; // Ledgers have subgroups as parents, or groups if no subgroup
                }

                // Make AJAX call to create ledger
                $.ajax({
                    url: '/api/ledger/create',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: 'Ledger created successfully!',
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                $('#addLedgerModal').modal('hide');
                                loadLedgerData(); // Reload the table
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: 'Creation failed: ' + (response.message || 'Unknown error')
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Creation failed: ' + (xhr.responseJSON?.message || error)
                        });
                    }
                });
            });

            $('#ledgerTable').on('click', '.edit-btn', function() {
                const ledgerId = $(this).data('id');
                const row = $(this).closest('tr');
                
                // Remove any existing modals and backdrops
                $('.modal').modal('hide');
                $('.modal-backdrop').remove();
                $('#editLedgerModal').remove();
                
                // Create a new modal for editing
                const editModal = `
                    <div class="modal fade" id="editLedgerModal" tabindex="-1" aria-labelledby="editLedgerModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editLedgerModalLabel">Edit Ledger</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="wizard">
                                        <div class="wizard-progress">
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar" style="width: 33%"></div>
                                            </div>
                                            <ul class="nav nav-pills">
                                                <li class="nav-item">
                                                    <a class="nav-link active" href="#editStep1" data-bs-toggle="pill">Basic Info</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" href="#editStep2" data-bs-toggle="pill">Type & Status</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" href="#editStep3" data-bs-toggle="pill">Additional Info</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="tab-content">
                                            <!-- Step 1: Basic Information -->
                                            <div class="tab-pane fade show active" id="editStep1">
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label for="editLedgerName" class="form-label">Ledger Name</label>
                                                        <input type="text" class="form-control" id="editLedgerName" value="${row.find('td:eq(1)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editCode" class="form-label">Code</label>
                                                        <input type="text" class="form-control" id="editCode" maxlength="16" value="${row.find('td:eq(11)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editGroupSelect" class="form-label">Group</label>
                                                        <select class="form-select" id="editGroupSelect">
                                                            <option value="">Select Group</option>
                                                            <option th:each="group : ${groups}" th:value="${group.id}" th:text="${group.ledgerName}"></option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editSubGroupSelect" class="form-label">Subgroup</label>
                                                        <select class="form-select" id="editSubGroupSelect">
                                                            <option value="">Select Subgroup</option>
                                                            <option th:each="subgroup : ${subgroups}" th:value="${subgroup.id}" th:text="${subgroup.ledgerName}"></option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editVersion" class="form-label">Version</label>
                                                        <input type="number" class="form-control" id="editVersion" value="${row.find('td:eq(10)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editApVersion" class="form-label">AP Version</label>
                                                        <input type="number" class="form-control" id="editApVersion" value="${row.find('td:eq(26)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editLedgerHeader" class="form-label">Ledger Header</label>
                                                        <input type="text" class="form-control" id="editLedgerHeader" maxlength="100" value="${row.find('td:eq(28)').text().trim()}">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Step 2: Type & Status -->
                                            <div class="tab-pane fade" id="editStep2">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editIsActive" class="form-label">Is Active</label>
                                                        <select class="form-select" id="editIsActive">
                                                            <option value="true" ${row.find('td:eq(7)').text().trim().toLowerCase() === 'true' ? 'selected' : ''}>Yes</option>
                                                            <option value="false" ${row.find('td:eq(7)').text().trim().toLowerCase() === 'false' ? 'selected' : ''}>No</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editIsDeleted" class="form-label">Is Deleted</label>
                                                        <select class="form-select" id="editIsDeleted">
                                                            <option value="false" ${row.find('td:eq(8)').text().trim().toLowerCase() === 'false' ? 'selected' : ''}>No</option>
                                                            <option value="true" ${row.find('td:eq(8)').text().trim().toLowerCase() === 'true' ? 'selected' : ''}>Yes</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Is Group</label>
                                                        <div class="d-flex gap-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editIsGroup" id="editIsGroupYes" value="true" ${row.find('td:eq(12)').text().trim().toLowerCase() === 'true' ? 'checked' : ''}>
                                                                <label class="form-check-label" for="editIsGroupYes">Yes</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editIsGroup" id="editIsGroupNo" value="false" ${row.find('td:eq(12)').text().trim().toLowerCase() === 'false' ? 'checked' : ''}>
                                                                <label class="form-check-label" for="editIsGroupNo">No</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Is Ledger</label>
                                                        <div class="d-flex gap-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editIsLedger" id="editIsLedgerYes" value="true" ${row.find('td:eq(13)').text().trim().toLowerCase() === 'true' ? 'checked' : ''}>
                                                                <label class="form-check-label" for="editIsLedgerYes">Yes</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editIsLedger" id="editIsLedgerNo" value="false" ${row.find('td:eq(13)').text().trim().toLowerCase() === 'false' ? 'checked' : ''}>
                                                                <label class="form-check-label" for="editIsLedgerNo">No</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Is SubGroup</label>
                                                        <div class="d-flex gap-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editIsSubGroup" id="editIsSubGroupYes" value="true" ${row.find('td:eq(14)').text().trim().toLowerCase() === 'true' ? 'checked' : ''}>
                                                                <label class="form-check-label" for="editIsSubGroupYes">Yes</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editIsSubGroup" id="editIsSubGroupNo" value="false" ${row.find('td:eq(14)').text().trim().toLowerCase() === 'false' ? 'checked' : ''}>
                                                                <label class="form-check-label" for="editIsSubGroupNo">No</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editIsEditable" class="form-label">Is Editable</label>
                                                        <select class="form-select" id="editIsEditable">
                                                            <option value="true" ${row.find('td:eq(22)').text().trim().toLowerCase() === 'true' ? 'selected' : ''}>Yes</option>
                                                            <option value="false" ${row.find('td:eq(22)').text().trim().toLowerCase() === 'false' ? 'selected' : ''}>No</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editIsOptional" class="form-label">Is Optional</label>
                                                        <select class="form-select" id="editIsOptional">
                                                            <option value="false" ${row.find('td:eq(25)').text().trim().toLowerCase() === 'false' ? 'selected' : ''}>No</option>
                                                            <option value="true" ${row.find('td:eq(25)').text().trim().toLowerCase() === 'true' ? 'selected' : ''}>Yes</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Step 3: Additional Information -->
                                            <div class="tab-pane fade" id="editStep3">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editCreatedBy" class="form-label">Created By</label>
                                                        <input type="number" class="form-control" id="editCreatedBy" value="${row.find('td:eq(15)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editUpdatedBy" class="form-label">Updated By</label>
                                                        <input type="number" class="form-control" id="editUpdatedBy" value="${row.find('td:eq(16)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editCreatedDate" class="form-label">Created Date</label>
                                                        <input type="datetime-local" class="form-control" id="editCreatedDate" value="${new Date(row.find('td:eq(6)').text().trim()).toISOString().slice(0, 16)}" readonly>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editUpdatedDate" class="form-label">Updated Date</label>
                                                        <input type="datetime-local" class="form-control" id="editUpdatedDate" value="${new Date(row.find('td:eq(9)').text().trim()).toISOString().slice(0, 16)}" readonly>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editLedgerTypeId" class="form-label">Ledger Type ID</label>
                                                        <input type="number" class="form-control" id="editLedgerTypeId" value="${row.find('td:eq(17)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editParentId" class="form-label">Parent ID</label>
                                                        <input type="number" class="form-control" id="editParentId" value="${row.find('td:eq(18)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editTbMenuId" class="form-label">Menu ID</label>
                                                        <input type="number" class="form-control" id="editTbMenuId" value="${row.find('td:eq(19)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editSerialNumber" class="form-label">Serial Number</label>
                                                        <input type="number" class="form-control" id="editSerialNumber" value="${row.find('td:eq(20)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-12 mb-3">
                                                        <label for="editFormula" class="form-label">Formula</label>
                                                        <input type="text" class="form-control" id="editFormula" value="${row.find('td:eq(21)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editDepreciationLedgerId" class="form-label">Depreciation Ledger ID</label>
                                                        <input type="number" class="form-control" id="editDepreciationLedgerId" value="${row.find('td:eq(23)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editAccumulatedDepreciationId" class="form-label">Accumulated Depreciation ID</label>
                                                        <input type="number" class="form-control" id="editAccumulatedDepreciationId" value="${row.find('td:eq(24)').text().trim()}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="editFsaAreaId" class="form-label">FSA Area ID</label>
                                                        <input type="number" class="form-control" id="editFsaAreaId" value="${row.find('td:eq(27)').text().trim()}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-secondary" id="editPrevBtn">Previous</button>
                                    <button type="button" class="btn btn-primary" id="editNextBtn">Next</button>
                                    <button type="button" class="btn btn-success" id="editSaveBtn" style="display: none;">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add the new modal to the body
                $('body').append(editModal);

                // Initialize the modal
                const modal = new bootstrap.Modal(document.getElementById('editLedgerModal'));
                
                // Set up wizard functionality
                let currentStep = 1;
                const totalSteps = 3;

                function updateWizardUI() {
                    // Update progress bar
                    const progress = (currentStep / totalSteps) * 100;
                    $('.progress-bar').css('width', progress + '%');

                    // Update navigation pills
                    $('.nav-pills .nav-link').removeClass('active');
                    $(`.nav-pills .nav-link[href="#editStep${currentStep}"]`).addClass('active');

                    // Update tab content
                    $('.tab-pane').removeClass('show active');
                    $(`#editStep${currentStep}`).addClass('show active');

                    // Update buttons
                    $('#editPrevBtn').toggle(currentStep > 1);
                    $('#editNextBtn').toggle(currentStep < totalSteps);
                    $('#editSaveBtn').toggle(currentStep === totalSteps);
                }

                // Bind next button
                $('#editNextBtn').on('click', function() {
                    if (currentStep < totalSteps) {
                        currentStep++;
                        updateWizardUI();
                    }
                });

                // Bind previous button
                $('#editPrevBtn').on('click', function() {
                    if (currentStep > 1) {
                        currentStep--;
                        updateWizardUI();
                    }
                });

                // Initialize wizard UI
                updateWizardUI();

                // Set group and subgroup selections
                const groupName = row.find('td:eq(3)').text().trim();
                const subGroupName = row.find('td:eq(5)').text().trim();

                // Update the group select options
                const groupSelect = $('#editGroupSelect');
                groupSelect.find('option').each(function() {
                    if ($(this).text() === groupName) {
                        $(this).prop('selected', true);
                    }
                });

                // Update the subgroup select options
                const subGroupSelect = $('#editSubGroupSelect');
                subGroupSelect.find('option').each(function() {
                    if ($(this).text() === subGroupName) {
                        $(this).prop('selected', true);
                    }
                });

                // Set radio button states
                const isGroup = row.find('td:eq(12)').text().trim().toLowerCase() === 'true';
                const isLedger = row.find('td:eq(13)').text().trim().toLowerCase() === 'true';
                const isSubGroup = row.find('td:eq(14)').text().trim().toLowerCase() === 'true';

                if (isGroup) {
                    $('#editIsGroupYes').prop('checked', true);
                    $('#editIsGroupNo').prop('checked', false);
                } else {
                    $('#editIsGroupYes').prop('checked', false);
                    $('#editIsGroupNo').prop('checked', true);
                }

                if (isLedger) {
                    $('#editIsLedgerYes').prop('checked', true);
                    $('#editIsLedgerNo').prop('checked', false);
                } else {
                    $('#editIsLedgerYes').prop('checked', false);
                    $('#editIsLedgerNo').prop('checked', true);
                }

                if (isSubGroup) {
                    $('#editIsSubGroupYes').prop('checked', true);
                    $('#editIsSubGroupNo').prop('checked', false);
                } else {
                    $('#editIsSubGroupYes').prop('checked', false);
                    $('#editIsSubGroupNo').prop('checked', true);
                }

                // Add mutual exclusivity for radio buttons
                $('input[name="editIsGroup"], input[name="editIsSubGroup"], input[name="editIsLedger"]').on('change', function() {
                    if ($(this).val() === 'true' && $(this).is(':checked')) {
                        if ($(this).attr('name') === 'editIsGroup') {
                            $('#editIsSubGroupNo, #editIsLedgerNo').prop('checked', true);
                        } else if ($(this).attr('name') === 'editIsSubGroup') {
                            $('#editIsGroupNo, #editIsLedgerNo').prop('checked', true);
                        } else if ($(this).attr('name') === 'editIsLedger') {
                            $('#editIsGroupNo, #editIsSubGroupNo').prop('checked', true);
                        }
                    }
                });

                // Handle save button click
                $('#editSaveBtn').on('click', function() {
                    const now = new Date();
                    function getValueOrNull(selector) {
                        const val = $(selector).val();
                        return val === '' ? null : val;
                    }

                    const formData = {
                        id: ledgerId,
                        ledgerName: getValueOrNull('#editLedgerName'),
                        code: getValueOrNull('#editCode'),
                        version: getValueOrNull('#editVersion'),
                        apVersion: getValueOrNull('#editApVersion'),
                        ledgerHeader: getValueOrNull('#editLedgerHeader'),
                        isActive: $('#editIsActive').val() === 'true',
                        isDeleted: $('#editIsDeleted').val() === 'true',
                        isGroup: $('#editIsGroupYes').is(':checked'),
                        isLedger: $('#editIsLedgerYes').is(':checked'),
                        isSubGroup: $('#editIsSubGroupYes').is(':checked'),
                        isEditable: $('#editIsEditable').val() === 'true',
                        isOptional: $('#editIsOptional').val() === 'true',
                        createdBy: getValueOrNull('#editCreatedBy'),
                        updatedBy: getValueOrNull('#editUpdatedBy'),
                        ledgerTypeId: getValueOrNull('#editLedgerTypeId'),
                        parentId: getValueOrNull('#editParentId'),
                        tbMenuId: getValueOrNull('#editTbMenuId'),
                        serialNumber: getValueOrNull('#editSerialNumber'),
                        formula: getValueOrNull('#editFormula'),
                        depreciationLedgerId: getValueOrNull('#editDepreciationLedgerId'),
                        accumulatedDepreciationId: getValueOrNull('#editAccumulatedDepreciationId'),
                        fsaAreaId: getValueOrNull('#editFsaAreaId'),
                        createdDate: row.find('td:eq(6)').text().trim(),
                        updatedDate: now.toISOString()
                    };

                    // Make AJAX call to update ledger
                    $.ajax({
                        url: '/api/ledger/update',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: 'Ledger updated successfully!',
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    modal.hide();
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error!',
                                    text: 'Update failed: ' + (response.message || 'Unknown error')
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: 'Update failed: ' + (xhr.responseJSON?.message || error)
                            });
                        }
                    });
                });

                // Handle modal close
                $('#editLedgerModal').on('hidden.bs.modal', function() {
                    $(this).remove();
                    $('.modal-backdrop').remove();
                });

                // Show the modal
                modal.show();
            });
        });
    </script>


</body>
</html>
